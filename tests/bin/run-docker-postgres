#!/bin/bash

set -eu -o pipefail

CONTAINER_NAME="steady-postgres"
PRIMARY_DB="app"
JOBS_DB="queue"

ensure_db_exists() {
    local db_name="$1"
    docker exec "$CONTAINER_NAME" psql -U steady_queue -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='${db_name}'" | grep -q 1 \
        || docker exec "$CONTAINER_NAME" psql -U steady_queue -d postgres -c "CREATE DATABASE ${db_name} OWNER steady_queue"
}

if docker ps --format "table {{.Names}}" | grep -q "^${CONTAINER_NAME}$"; then
    echo "Container $CONTAINER_NAME is already running"
else
    echo "Starting container $CONTAINER_NAME"
    docker run --detach \
     --name "$CONTAINER_NAME" \
     --publish 5432:5432 \
     --env POSTGRES_DB=$PRIMARY_DB \
     --env POSTGRES_USER=steady_queue \
     --env POSTGRES_PASSWORD=steady_queue \
     postgres:17.4-alpine
fi

sleep 10

ensure_db_exists "$PRIMARY_DB"
ensure_db_exists "$JOBS_DB"

echo "Databases ensured: $PRIMARY_DB, $JOBS_DB"
